SELECT  INDEKS, IME, PREZIME 
FROM    DA.DOSIJE D
WHERE   IDPROGRAMA = 101 AND 
        EXISTS ( -- STUDENT JE PAO NEKI ISPIT
          SELECT *
          FROM DA.ISPIT I
          WHERE OCENA = 5 AND STATUS = 'o' AND D.INDEKS = I.INDEKS 
        );

-- +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

-- IZDVAJANJE STUDENTA SA NAJVISE BODOVA

WITH POMOCNA AS (
  SELECT    IDPROGRAMA, D.INDEKS, SUM(ESPB) SUMA
  FROM      DA.DOSIJE D JOIN DA.ISPIT I ON D.INDEKS = I.INDEKS 
            JOIN DA.PREDMET P ON I.IDPREDMETA = P.ID 
  WHERE     OCENA > 5 AND STATUS = 'o'
  GROUP BY  IDPROGRAMA, D.INDEKS
)
SELECT  P.SUMA, P.INDEKS, P.IDPROGRAMA
FROM POMOCNA P 
WHERE P.SUMA IN ( -- ZA JEDAN PROGRAM TRAZIMO NAJVECU SUMU 
  SELECT  MAX(P1.SUMA)
  FROM    POMOCNA P1 
  WHERE   P1.IDPROGRAMA = P.IDPROGRAMA  
)
ORDER BY P.IDPROGRAMA;

------------------------------------------------------------------------------

-- TRAZENJE POSLEDNJEG ISPITA 
-- AZURIRANJE !!!

WITH POMOCNA AS ( 
  SELECT    INDEKS, MAX(DATPOLAGANJA) DATUM_POSLEDNJEG
  FROM      DA.ISPIT 
  WHERE     OCENA > 5 AND STATUS = 'o'
  GROUP BY  INDEKS
  HAVING MAX(DATPOLAGANJA) IS NOT NULL
) 
SELECT  I.INDEKS 
FROM    DA.ISPIT I 
WHERE   I.INDEKS = 20171098 AND 
        EXISTS (
          SELECT * 
          FROM POMOCNA P 
          WHERE P.INDEKS = I.INDEKS AND P.DATUM_POSLEDNJEG = I.DATPOLAGANJA
          );
